# システムアーキテクチャ

このドキュメントでは、Yahoo News Stream アプリケーションのシステム構成とアーキテクチャについて説明します。

## 目次

- [全体構成](#全体構成)
- [アーキテクチャパターン](#アーキテクチャパターン)
- [コンポーネント構成](#コンポーネント構成)
- [データフロー](#データフロー)
- [キャッシュ戦略](#キャッシュ戦略)
- [非同期処理](#非同期処理)
- [デプロイ構成](#デプロイ構成)

---

## 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                          Browser                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Frontend (index.html)                    │   │
│  │  - HTML/CSS/JavaScript                               │   │
│  │  - News Display UI                                   │   │
│  │  - Auto-refresh (2 min)                              │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────┬──────────────────────────────────────────┘
                   │ HTTP/JSON
                   ↓
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI Application                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                Backend (main.py)                      │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │           API Endpoints Layer                   │  │   │
│  │  │  - GET /                                       │  │   │
│  │  │  - GET /api/news                               │  │   │
│  │  │  - GET /health                                 │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │           Business Logic Layer                  │  │   │
│  │  │  - News Fetching                               │  │   │
│  │  │  - Data Merging                                │  │   │
│  │  │  - Cache Management                            │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │           Data Source Layer                     │  │   │
│  │  │  - RSS Fetcher (feedparser)                    │  │   │
│  │  │  - Web Scraper (BeautifulSoup4)                │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────┬──────────────────────┬───────────────────┘
                   │                      │
                   ↓                      ↓
         ┌─────────────────┐   ┌─────────────────────┐
         │  Yahoo News RSS │   │ Yahoo News Website  │
         │   Feed Server   │   │   (Scraping)        │
         └─────────────────┘   └─────────────────────┘
```

---

## アーキテクチャパターン

### 1. レイヤードアーキテクチャ

アプリケーションは以下の3層で構成されています：

#### プレゼンテーション層
- **フロントエンド**: HTML/CSS/JavaScript
- **API**: FastAPIエンドポイント
- 責務: ユーザーインターフェース、リクエスト/レスポンス処理

#### ビジネスロジック層
- データ取得ロジック
- キャッシュ管理
- データマージング
- 責務: アプリケーションの中核機能

#### データソース層
- RSS取得
- Webスクレイピング
- 責務: 外部データソースとの連携

### 2. BFF (Backend For Frontend) パターン

バックエンドがフロントエンドのために最適化されたAPIを提供：
- 単一のエンドポイント`/api/news`でフロントエンドに必要なデータを提供
- データ形式の変換と整形
- 複数のデータソースを統合

---

## コンポーネント構成

### バックエンドコンポーネント

```python
# main.py の構造

┌────────────────────────────────────────────────┐
│         FastAPI Application (app)              │
└────────────────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        ↓            ↓            ↓
   ┌─────────┐  ┌─────────┐  ┌─────────┐
   │ Routes  │  │ Cache   │  │ Fetchers│
   └─────────┘  └─────────┘  └─────────┘
        │            │            │
        │            │            │
   ┌─────────┐  ┌─────────┐  ┌─────────┐
   │GET /    │  │Memory   │  │RSS      │
   │GET /api │  │Lock     │  │Scraper  │
   │GET /heal│  │TTL Check│  │         │
   └─────────┘  └─────────┘  └─────────┘
```

#### 主要な関数とその役割

| 関数/変数                | 責務                                |
|------------------------|-------------------------------------|
| `app`                  | FastAPIアプリケーションインスタンス        |
| `templates`            | Jinja2テンプレートエンジン               |
| `_cache`               | メモリ内キャッシュストレージ              |
| `_cache_lock`          | キャッシュアクセスの排他制御              |
| `_fetch_rss()`         | RSSフィードからニュースを取得            |
| `_fetch_scrape()`      | Webスクレイピングでニュースを取得         |
| `_merge_items()`       | 複数ソースのニュースをマージ              |
| `_fetch_news()`        | ソースに応じたニュース取得のルーティング     |
| `_refresh_cache()`     | キャッシュの更新                       |
| `_is_cache_fresh()`    | キャッシュの有効性チェック               |
| `_clamp_limit()`       | リミット値のバリデーション               |
| `root()`               | HTMLページ配信エンドポイント             |
| `get_news()`           | ニュースAPI エンドポイント              |
| `health()`             | ヘルスチェックエンドポイント              |

### フロントエンドコンポーネント

```
index.html
├── HTML Structure
│   ├── Header (Title, Description)
│   ├── Controls (Source, Limit, Refresh Button)
│   └── Grid (News Cards)
├── CSS Styles
│   ├── Design System (CSS Variables)
│   ├── Responsive Layout
│   └── Dark Theme
└── JavaScript Logic
    ├── Event Handlers
    ├── API Client (fetch)
    └── DOM Manipulation
```

---

## データフロー

### ニュース取得フロー

```
[User Action] → [Frontend] → [Backend API] → [Cache Check]
                                                   ↓
                                            [Cache Valid?]
                                             ↙        ↘
                                          YES         NO
                                           ↓          ↓
                                    [Return Cache] [Fetch Data]
                                                      ↓
                                              [Update Cache]
                                                      ↓
                                              [Return Data]
                                                      ↓
                    [Render UI] ← [Frontend] ← [JSON Response]
```

### 詳細なニュース取得シーケンス

```
User                Frontend            Backend              Yahoo News
  │                    │                   │                      │
  │  1. Click Refresh  │                   │                      │
  ├───────────────────→│                   │                      │
  │                    │  2. GET /api/news │                      │
  │                    ├──────────────────→│                      │
  │                    │                   │  3. Check Cache      │
  │                    │                   ├─────────┐            │
  │                    │                   │←────────┘            │
  │                    │                   │                      │
  │                    │                   │  4a. Cache Fresh?    │
  │                    │                   │      ↓ NO            │
  │                    │                   │  5. Fetch RSS        │
  │                    │                   ├─────────────────────→│
  │                    │                   │←─────────────────────┤
  │                    │                   │  6. Parse Feed       │
  │                    │                   ├─────────┐            │
  │                    │                   │←────────┘            │
  │                    │                   │  7. Fetch Scrape     │
  │                    │                   ├─────────────────────→│
  │                    │                   │←─────────────────────┤
  │                    │                   │  8. Parse HTML       │
  │                    │                   ├─────────┐            │
  │                    │                   │←────────┘            │
  │                    │                   │  9. Merge & Cache    │
  │                    │                   ├─────────┐            │
  │                    │                   │←────────┘            │
  │                    │  10. JSON Response│                      │
  │                    │←──────────────────┤                      │
  │  11. Update UI     │                   │                      │
  │←───────────────────┤                   │                      │
```

---

## キャッシュ戦略

### キャッシュストラクチャ

```python
_cache = {
    "rss": {
        "items": [...],          # ニュース記事の配列
        "fetched_at": 1708012345.67,  # UNIX timestamp
        "limit": 10              # 取得時のlimit値
    },
    "scrape": { ... },
    "mixed": { ... }
}
```

### キャッシュポリシー

#### TTL (Time To Live)
- **デフォルト**: 300秒（5分）
- **目的**: Yahoo Newsへのアクセス頻度を抑制

#### Write-Through Strategy
- データ取得時に即座にキャッシュを更新
- 取得失敗時は古いキャッシュを保持

#### Cache Warming
- バックグラウンドタスクでキャッシュを更新
- ユーザーには古いデータを即座に返す

### キャッシュの排他制御

```python
_cache_lock = asyncio.Lock()
```

- 複数のリクエストが同時にキャッシュを更新しないように制御
- デッドロックを防ぐための非同期ロック

---

## 非同期処理

### Asyncio の活用

```python
async def _fetch_rss(limit: int):
    async with httpx.AsyncClient(...) as client:
        response = await client.get(RSS_URL)
    # ...
```

**利点**:
- I/O待機中に他のリクエストを処理可能
- スケーラビリティの向上
- リソース効率の改善

### バックグラウンドタスク

```python
@app.get("/api/news")
async def get_news(background_tasks: BackgroundTasks, ...):
    # ...
    background_tasks.add_task(_refresh_cache, source, limit)
    return JSONResponse(cached_items[:limit])
```

**利点**:
- レスポンスタイムの短縮
- ユーザー体験の向上
- 非同期キャッシュ更新

---

## デプロイ構成

### Render での構成

```
┌──────────────────────────────────────────┐
│           Render Platform                │
│  ┌────────────────────────────────────┐  │
│  │       Web Service Container        │  │
│  │  ┌──────────────────────────────┐  │  │
│  │  │     uvicorn (ASGI Server)    │  │  │
│  │  │  ┌────────────────────────┐  │  │  │
│  │  │  │  FastAPI Application   │  │  │  │
│  │  │  │  - API Endpoints       │  │  │  │
│  │  │  │  - Templates           │  │  │  │
│  │  │  └────────────────────────┘  │  │  │
│  │  └──────────────────────────────┘  │  │
│  │   Port: $PORT (Dynamic)            │  │
│  └────────────────────────────────────┘  │
│              ↓                           │
│  ┌────────────────────────────────────┐  │
│  │      HTTPS Load Balancer           │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
           ↓
    Public Internet
```

### ディレクトリマッピング

```
Repository Root
├── backend/       ← rootDirectory (Render設定)
│   ├── main.py    ← Pythonアプリケーション
│   ├── requirements.txt
│   └── runtime.txt
└── frontend/
    └── index.html ← ../frontend/ で参照
```

### 環境変数

| 変数名  | 説明                          | 提供元   |
|---------|------------------------------|---------|
| $PORT   | アプリケーションのリスニングポート | Render  |

---

## スケーラビリティ考慮事項

### 現在の制約

1. **キャッシュがメモリ内のみ**
   - 複数インスタンス間で共有されない
   - サーバー再起動でクリアされる

2. **単一サーバー構成**
   - 水平スケールアウトに制限

### 改善案

#### キャッシュの外部化
```python
# Redis を使用した例
import redis.asyncio as redis

cache = redis.Redis(host='localhost', port=6379)
```

#### セッションストア
- Redisを使用して複数インスタンス間でキャッシュを共有

#### ロードバランシング
- 複数のFastAPIインスタンスをデプロイ
- Renderの有料プランでスケーリング

---

## セキュリティ考慮事項

### 現在の実装

1. **HTTPSのみ（Render経由）**
2. **User-Agent設定** - ボット判定を回避
3. **タイムアウト設定** - DoS攻撃対策

### 追加推奨事項

1. **レート制限**
   ```python
   from slowapi import Limiter
   limiter = Limiter(key_func=get_remote_address)
   ```

2. **CORS設定**
   - 必要に応じて許可オリジンを制限

3. **入力検証**
   - 現在は自動補正のみ
   - より厳格なバリデーションも検討可能

---

## モニタリングとログ

### 現在の実装

- uvicornのデフォルトログ
- 標準出力への出力

### 推奨する追加項目

1. **構造化ログ**
   ```python
   import structlog
   logger = structlog.get_logger()
   ```

2. **メトリクス収集**
   - Prometheus形式でメトリクスをエクスポート
   - レスポンスタイム、エラー率などを監視

3. **エラートラッキング**
   - Sentryなどのエラートラッキングサービス

---

## 将来の拡張性

### 考えられる拡張

1. **データベース統合**
   - ニュース記事の永続化
   - 閲覧履歴の保存

2. **ユーザー認証**
   - ユーザーごとの設定保存
   - お気に入り機能

3. **通知機能**
   - WebSocketを使ったリアルタイム更新
   - プッシュ通知

4. **多言語対応**
   - 複数の言語のニュースソースをサポート

5. **データ分析**
   - トレンド分析
   - 記事の分類・タグ付け
